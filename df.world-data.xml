<data-definition>
    <struct-type type-name='resource_allotmentst'>
        <int32_t name="production_zone_index"/>
        <enum name="allotment" type-name='resource_allotment_specifier_type'/>
        <int32_t name="special_controlling_entity_id"/>
        <stl-vector name="count" type-name='int32_t'/>
    </struct-type>

    <struct-type type-name='resource_pilest'>
        <int32_t name="id"/>

        <stl-vector name="allotment" pointer-type='resource_allotmentst'/>

        <stl-vector name="allotment_stone" pointer-type='resource_allotmentst' comment='optional'/>
        <stl-vector name="allotment_food" pointer-type='resource_allotmentst' comment='optional'/>
        <stl-vector name="allotment_crop" pointer-type='resource_allotmentst' comment='optional'/>
    </struct-type>

    <enum-type type-name="world_population_type"> bay12: WilderPopTypes
        <enum-item name='Animal' comment='ROAMING'/>
        <enum-item name='Vermin'/>
        <enum-item name='Unused3'/>
        <enum-item name='VerminInnumerable' comment='SOIL'/>
        <enum-item name='ColonyInsect' comment='SOIL_COLONY'/>
        <enum-item name='Tree'/>
        <enum-item name='Grass'/>
        <enum-item name='Bush'/>
        <enum-item name='Unused9'/>
    </enum-type>

    <struct-type type-name='world_population_ref' original-name='regionpopinfost'>
        <int16_t name="region_x"/>
        <int16_t name="region_y"/>
        <int16_t name="feature_idx" init-value="-1"/>

        <int32_t name='cave_id' ref-target='world_underground_region'/>

        <int32_t name='site_id' ref-target='world_site'/>

        <int32_t name="population_idx">
            <code-helper name='refers-to'>
                (let* ((info $$._global)
                       (wdata $global.world.world_data)
                       (x $info.region_x)
                       (y $info.region_y)
                       (reg (or (when (/= $info.feature_idx -1)
                                  (let* ((rip $wdata.feature_map[(floor x 16)][(floor y 16)])
                                         (flst $rip.features.feature_init[(logand x 15)][(logand y 15)]))
                                    $flst[$info.feature_idx].feature))
                                (awhen $info.cave_id.ref-target
                                  $it.feature_init.feature)
                                (find-instance $world_region ;
                                               $wdata.region_map[x][y].region_id))))
                  $reg.population[$])
            </code-helper>
        </int32_t>

        <enum base-type='int16_t' name='depth' type-name='layer_type' comment="Doesn't look correct. See -1, 0, 41, 172, 508, and 686 with critters visible in all caverns. Some dead, but the dorf on the surface isn't"/>
    </struct-type>

    <struct-type type-name='local_population' original-name='wilderpopst'>
        <enum base-type='int8_t' name='type' type-name='world_population_type'/>

        <compound is-union='true'>
            <int16_t name="race" ref-target='creature_raw'/>
            <int16_t name="plant" ref-target='plant_raw'/>
        </compound>

        <int32_t name="quantity"/>
        <int32_t name="quantity_max" since='v0.40.01'/>

        <bitfield name='flags' base-type='uint8_t'> bay12: WILDERPOPFLAG_*
            <flag-bit name='discovered'/>
            <flag-bit name='extinct'/>
            <flag-bit name='already_removed' comment='no longer in world.populations'/>
            <flag-bit name='need_offload'/>
        </bitfield>

        <compound name='population' type-name='world_population_ref'/>

        <int32_t name="breed" ref-target='breed'/>
        <int32_t name='interaction_idx' init-value='-1'/>
        <int32_t name='interaction_instance' init-value='-1'/>
        <int32_t name='interaction_effect' init-value='-1'/>
    </struct-type>

    <struct-type type-name='world_population' original-name='regionpopst'>
        <enum base-type='int16_t' name='type' type-name='world_population_type'/>

        <compound is-union='true'>
            <int16_t name="race" ref-target='creature_raw'/>
            <int16_t name="plant" ref-target='plant_raw'/>
        </compound>

        <int32_t name="count_min" init-value='10000001'/>
        <int32_t name="count_max" init-value='10000001'/>

        <int32_t name='temp_num' init-value='0' since='v0.40.01'/>

        <int32_t name="owner" ref-target='historical_entity'/>
        <int32_t name="breed" ref-target='breed'/>
        <int32_t name="production_zone" init-value='-1'/>

        <int32_t name='interaction_idx' init-value='-1' since='v0.34.01'/>
        <int32_t name='interaction_instance' init-value='-1' since='v0.34.01'/>
        <int32_t name='interaction_effect' init-value='-1' since='v0.47.01'/>
    </struct-type>

    <enum-type type-name='region_weather_type' base-type='int32_t'> bay12: RegionWeatherType
        <enum-item name='CreepingGas'/>
        <enum-item name='CreepingVapor' comment="doesn't seem to be generated by DF, but appears if hacked"/>
        <enum-item name='CreepingDust'/>
        <enum-item name='FallingMaterial' comment="a.k.a. rain, both blood and syndrome, but not regular"/>
    </enum-type>

    <struct-type type-name='region_weather' key-field='id' instance-vector='$global.world.world_data.region_weather' original-name='region_weatherst' comment="only evil weather, not the regular kind">
        <int32_t name='id'/>
        <enum name='type' type-name='region_weather_type' comment="Creeping Gas/Vapor/Dust='cloud' below, FallingMaterial='rain'"/>
        <int16_t name='mat_type' ref-target='material' aux-value='$$.mat_index'/>
        <int32_t name='mat_index'/>
        <bitfield name='flags' base-type='uint8_t'> bay12: REGION_WEATHER_FLAG_*
            <flag-bit name='announced'/>
        </bitfield>
        <int32_t name='region_x' comment="world tile, used with evil rain. Probably uninitialized with cloud"/>
        <int32_t name='region_y' comment="world tile, used with evil rain. Probably uninitialized with cloud"/>
        <int32_t name='world_in_game_x' init-value='-30000' comment="used with evil clouds, indicating global in-game coordinates"/>
        <int32_t name='world_in_game_y' init-value='-30000' comment="used with evil clouds, indicating global in-game coordinates"/>
        <int32_t name='world_in_game_z' init-value='-30000' comment="probably never used, as weather appears on the surface"/>
        <int32_t name='cloud_x_movement' comment="-1/0/1, indicating the movement per 10 ticks in X direction. Uninitialized for rain"/>
        <int32_t name='cloud_y_movement' comment="-1/0/1, indicating the movement per 10 ticks in Y direction. Uninitialized for rain"/>
        <int32_t name='remaining_duration' comment="ticks down 1 every 10 ticks. Removed some time after reaching 0. Cloud duration seems to start with a fairly large, but somewhat random value"/>
        <int32_t name='region_id' ref-target='world_region' comment="Set for clouds, -1 for rain"/>
    </struct-type>
</data-definition>

<!--
Local Variables:
indent-tabs-mode: nil
nxml-child-indent: 4
End:
-->

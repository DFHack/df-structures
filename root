{"version":1,"ops":[{"type":1,"author":{"id":"b557f89d859694906b6aaad860dfa0f74f23dbaa"},"timestamp":1532938924,"metadata":{"github-id":"MDU6SXNzdWUzNDU2NTc0NjA=","github-url":"https://github.com/DFHack/df-structures/issues/299","origin":"github"},"title":"Invalid unit_personality's current_focus and undistracted_focus on 32 bits platforms","message":"Expected values are 98 and 96 (4*24 needs).\n```\n\u003cunit_personality: 0xcf815b20\u003e\nvalues                 \t = \u003cvector\u003cunit_personality.T_values*\u003e[4]: 0xcf815b20\u003e\nunk_v40_2              \t = \u003cvector\u003cunit_personality.T_unk_v40_2*\u003e[0]: 0xcf815b2c\u003e\nemotions               \t = \u003cvector\u003cunit_personality.T_emotions*\u003e[2]: 0xcf815b38\u003e\ndreams                 \t = \u003cvector\u003cunit_personality.T_dreams*\u003e[1]: 0xcf815b44\u003e\nnext_dream_id          \t = 1\nunk_v40_6              \t = \u003cvector\u003cunit_personality.T_unk_v40_6*\u003e[0]: 0xcf815b54\u003e\ntraits                 \t = \u003cuint16_t[]: 0xcf815b60\u003e\nciv_id                 \t = 9\ncultural_identity      \t = -1\nunk5                   \t = \u003cvector\u003cunit_personality.T_unk5*\u003e[1]: 0xcf815bcc\u003e\nunk6                   \t = \u003cvector\u003cint16_t\u003e[0]: 0xcf815bd8\u003e\nstress_level           \t = 40\nunk_v4014_2            \t = 0\nunk_v4014_3            \t = 2800\nunk_v4019_1            \t = 2\nunk_v4019_2            \t = 0\nneeds                  \t = \u003cvector\u003cunit_personality.T_needs*\u003e[24]: 0xcf815bf8\u003e\nflags                  \t = \u003cunit_personality.T_flags: 0xcf815c04\u003e\ntemporary_trait_changes\t = nil\nunk_v4201_3            \t = -1\nunk_v4201_4            \t = -1\nunk_v4410_1            \t = 0\nunk_v4410_2            \t = 98\ncurrent_focus          \t = 96\nundistracted_focus     \t = -828746448\n```\n\nThe change I made in #264 was not the good one. Could unk_v4410_1 and unk_v4410_2 be a single pointer? \n\n-828746448 must be the correct value for the performance_skills pointer. When I try to read the current field, it is null or invalid:\n```\n[DFHack]# :lua ~dfhack.gui.getSelectedUnit().status.current_soul.performance_skills\nnil\n```\nanother unit:\n```\n[DFHack]# :lua ~dfhack.gui.getSelectedUnit().status.current_soul.performance_skills\n\u003cunit_soul.T_performance_skills: 0xaf0200\u003e\nnil\nstack traceback:\n\t[C]: in ?\n\t[C]: in function 'tostring'\n\t./hack/lua/dfhack.lua:169: in function 'printall'\n\t...e/clement/games/df/df_44_12_linux32/hack/scripts/lua.lua:68: in local 'script_code'\n\t./hack/lua/dfhack.lua:680: in function 'dfhack.run_script_with_env'\n\t(...tail calls...)\n```\n(DFHack command line is broken after that)\n\nThese tests were done on linux 32 bits, but I have the same issues with the Dwarf Therapist memory layouts I generated for windows 32 bits.","files":null}]}
{"version":1,"ops":[{"type":1,"author":{"id":"101b01e066e9b09a918258a0eaf11e451da2ef60"},"timestamp":1480355845,"metadata":{"github-id":"MDU6SXNzdWUxOTIwNzM5OTU=","github-url":"https://github.com/DFHack/df-structures/issues/165","origin":"github"},"title":"linux 64-bit: extra bytes between building_def","message":"On 64 bit linux df crashes when creating a custom workshop (soapmaker's) while dfhack's labormanager is on. Testing in VMs it works on 32 bit linux and 32 or 64 bit windows. The problem is between needs_magma and build_items in building_def (https://github.com/DFHack/df-structures/blob/master/df.building-raws.xml). Running debug prints on 64 bit linux I get\n\n```\n8 code: SOAP_MAKER\n10 id: 0\n18 name: Soap Maker's Workshop\n20 building_type: ...\n24 building_subtype: 17\n28 name_color: ...\n2e tile: ...\nf32 tile_color: ...\n3c3e tile_block: ...\n4000 build_key: 96\n4004 needs_magma: 0\n4008 build_items: .size() = -147855838\n4020 dim_x: b97f3120\n4024 dim_y: 7fff\n4028 workloc_x: 3\n402c workloc_y: 3\n4030 build_labors: .size() = -1368175537\n4048 labor_description: ï¿½\n4050 build_stages: b960a0c8\n4004: 00000000\n4008: 00000000\n400c: 00000000\n4010: b97f3110\n4014: 00007fff\n4018: b97f3120\n401c: 00007fff\n4020: b97f3120\n4024: 00007fff\n4028: 00000003\n402c: 00000003\n4030: 00000001\n4034: 00000001\n4038: b9cd3140\n403c: 00007fff\n4040: b9cd3144\n4044: 00007fff\n4048: b9cd3144\n404c: 00007fff\n[DFHack]# Segmentation fault (core dumped)\n\n```\nadding enough padding to bump build_items to its next alignment makes everything work:\n```\n8 code: SOAP_MAKER\n10 id: 0\n18 name: Soap Maker's Workshop\n20 building_type: ...\n24 building_subtype: 17\n28 name_color: ...\n2e tile: ...\nf32 tile_color: ...\n3c3e tile_block: ...\n4000 build_key: 96\n4004 needs_magma: 0\n4005 mystery[0]: 0\n4006 mystery[1]: 0\n4007 mystery[2]: 0\n4008 mystery[3]: 0\n4009 mystery[4]: 0\n400a mystery[5]: 0\n400b mystery[6]: 0\n400d mystery[8]: 0\n400e mystery[9]: 0\n400f mystery[10]: 0\n4010 build_items: .size() = 2\n4028 dim_x: 3\n402c dim_y: 3\n4030 workloc_x: 1\n4034 workloc_y: 1\n4038 build_labors: .size() = 1\n4050 labor_description: Soap Making\n4058 build_stages: 3\n4004: 00000000\n4008: 00000000\n400c: 00000000\n4010: b9cc3960\n4014: 00007fff\n4018: b9cc3970\n401c: 00007fff\n4020: b9cc3970\n4024: 00007fff\n4028: 00000003\n402c: 00000003\n4030: 00000001\n4034: 00000001\n4038: b9dae7d0\n403c: 00007fff\n4040: b9dae7d4\n4044: 00007fff\n4048: b9dae7d4\n404c: 00007fff\n4050: b960fe98\n4054: 00007fff\n[DFHack]# \n\n```\nSo on 64-bit linux build_items is 8 bytes off.\n\n(EDIT) I can set [NEEDS_MAGMA] in the raws, and it results in:\n\n```\n8 code: SOAP_MAKER\n10 id: 0\n18 name: Soap Maker's Workshop\n20 building_type: ...\n24 building_subtype: 17\n28 name_color: ...\n2e tile: ...\nf32 tile_color: ...\n3c3e tile_block: ...\n4000 build_key: 96\n4004 needs_magma: 0\n4005 mystery[0]: 0\n4006 mystery[1]: 0\n4007 mystery[2]: 0\n4008 mystery[3]: 1\n4009 mystery[4]: 0\n400a mystery[5]: 0\n400b mystery[6]: 0\n400d mystery[8]: 0\n400e mystery[9]: 0\n400f mystery[10]: 0\n4010 build_items: .size() = 2\n4028 dim_x: 3\n402c dim_y: 3\n4030 workloc_x: 1\n4034 workloc_y: 1\n4038 build_labors: .size() = 1\n4050 labor_description: Soap Making\n4058 build_stages: 3\n4004: 00000000\n4008: 00000001\n400c: 00000000\n4010: b9cd85e0\n4014: 00007fff\n4018: b9cd85f0\n401c: 00007fff\n4020: b9cd85f0\n4024: 00007fff\n4028: 00000003\n402c: 00000003\n4030: 00000001\n4034: 00000001\n4038: b9cff3a0\n403c: 00007fff\n4040: b9cff3a4\n4044: 00007fff\n4048: b9cff3a4\n404c: 00007fff\n4050: b964a298\n4054: 00007fff\n\n```\nso needs_magma is 4 bytes off. It seems the cause is that build_key is a long, which is 4 bytes on MS and 32 bit gcc but 8 bytes on 64 bit gcc. I can't work a debugger well enough to really confirm it though.","files":null}]}
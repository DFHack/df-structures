{"version":1,"ops":[{"type":1,"author":{"id":"25c4158f5dcc139ae07acba5a747e2de0c904e43"},"timestamp":1481140393,"metadata":{"github-id":"MDU6SXNzdWUxOTQxNTExMTg=","github-url":"https://github.com/DFHack/df-structures/issues/169","origin":"github"},"title":"Bitfields cannot be used inside unions","message":"Bitfields cannot be used inside unions because they have non-trivial default constructors. This necessitates the use of `int32_t` in a few places a bitfield would be preferable (see 22819e2e37c03505d184fc4e89c4a4fd67b92995). The default constructor, [generated by Bitfield.pm](https://github.com/DFHack/df-structures/blob/274687583728a5e4981d25bab44b4f0c08cd78c5/Bitfield.pm#L80), looks like `foo(int32_t whole_ = 0) : whole(whole_) {};`. This allows constructing a bitfield with some flags set.\n\nI propose that the non-trivial constructor be removed. The compiler-synthesized constructor will set all the flags to 0. The convenience of bitfields in unions outweighs the inconvenience of not having the current constructor, especially for Lua.\n\nA quick check indicates that the one-argument form is not even used (except with 0, which is unnecessary), so this change would not break anything:\n```console\n$ gawk 'match($0, /\u003cbitfield(-type)? .*name=.(\\w*)/, a) { print \"\\\\\u003c\" (a[1] ? \"\" : \"T_\") a[2] \" *\\\\(\\\\w\\\\+ *\\\\)\\\\?(\" }' df-structures/df.*.xml | grep -f - -r dfhack\ndfhack/library/include/modules/MapCache.h:    df::tile_designation DesignationAt(df::coord2d p)\ndfhack/library/include/modules/MapCache.h:    df::tile_occupancy OccupancyAt(df::coord2d p)\ndfhack/library/include/modules/MapCache.h:    df::tile_designation designationAt (DFCoord tilecoord)\ndfhack/library/include/modules/MapCache.h:        return b ? b-\u003eDesignationAt(tilecoord) : df::tile_designation(0);\ndfhack/library/include/modules/MapCache.h:    df::tile_occupancy occupancyAt (DFCoord tilecoord)\ndfhack/library/include/modules/MapCache.h:        return b ? b-\u003eOccupancyAt(tilecoord) : df::tile_occupancy(0);\ndfhack/library/modules/Gui.cpp:    df::announcement_flags mode(0);\ndfhack/library/modules/Gui.cpp:    df::announcement_flags mode(0);\ndfhack/library/modules/Gui.cpp:    df::announcement_flags flags(0);\ndfhack/library/modules/Maps.cpp:    df::tile_designation dsgn(0);\ndfhack/plugins/burrows.cpp:    df::tile_designation mask(0);\ndfhack/plugins/burrows.cpp:    df::tile_designation value(0);\ndfhack/plugins/workflow.cpp:    df::dfhack_material_category mat_mask(0);\ndfhack/plugins/workflow.cpp:    df::dfhack_material_category mat_mask(0);\n```","files":null}]}